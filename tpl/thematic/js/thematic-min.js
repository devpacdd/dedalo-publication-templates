var thematic={row:null,tree:null,form:null,tree_raw_data:null,init:function(e){const t=this;return t.row=e.row,new Promise((function(n){t.table=environment.thesaurus_tables,t.root_term=environment.thesaurus_root_terms,t.term_id=e.term_id||null;const r=["./common/factory/tree_factory.js"],i=[];for(let e=0;e<r.length;e++)i.push(new Promise((function(t,n){const i=document.createElement("script");i.src=r[e]+"?"+environment.version,i.addEventListener("load",(function(){t(!0)})),document.head.appendChild(i)})));Promise.all(i).then((function(){n(!0)})),event_manager.subscribe("show_indexation_nodes",t.render_indexation_nodes),event_manager.subscribe("open_player",t.open_player)}))},render:function(){const e=this,t=e.row,n=new DocumentFragment,r=page.render_lang_selector();n.appendChild(r);const i=page.render_menu();n.appendChild(i);const o=document.createElement("div");o.classList.add("wrapper"),n.appendChild(o);const a=document.createElement("h1");if(a.classList.add("title"),a.insertAdjacentHTML("afterbegin",t.title),o.appendChild(a),t.abstract){const e=document.createElement("div");e.classList.add("abstract"),e.insertAdjacentHTML("afterbegin",t.abstract),o.appendChild(e)}if(t.body){const e=document.createElement("div");e.classList.add("body"),e.insertAdjacentHTML("afterbegin",t.body),o.appendChild(e)}return e.form=e.render_form(),n.appendChild(e.form),e.rows_list_node=document.createElement("div"),e.rows_list_node.classList.add("rows_list_node"),n.appendChild(e.rows_list_node),e.load_tree_data({}).then((function(t){e.render_tree_data({rows:t,set_hilite:e.term_id&&e.term_id.length>0}).then((function(){}))})),n},render_tree_data:function(e){const t=this,n=e.rows,r=e.set_hilite||!1;return new Promise((function(e){const i=t.term_id?[t.term_id]:null,o=t.parse_tree_data(n,i);t.tree=t.tree||new tree_factory,t.tree.init({target:t.rows_list_node,data:o,root_term:t.root_term,set_hilite:r,caller:t}),t.tree.render().then((function(){e(!0)}))}))},load_tree_data:function(){const e=this;return new Promise((function(t){if(e.tree_raw_data&&e.tree_raw_data.length>0){const n=JSON.parse(JSON.stringify(e.tree_raw_data));return void t(n)}const n={dedalo_get:"records",table:e.table,ar_fields:["*"],sql_filter:null,limit:0,count:!1,order:"norder ASC"};data_manager.request({body:n}).then((function(n){if(console.log("load_tree_data response:",n),n.result){const r=n.result;e.tree_raw_data=r,t(r)}else console.warn("Emty data from tree:",n),t([])}))}))},parse_tree_data:function(e){const t=JSON.parse(JSON.stringify(e)),n=[],r=this.term_id?[this.term_id]:null,i=["parent","childrens","space","indexation"];function o(e){for(let n=i.length-1;n>=0;n--){const r=i[n];e[r]=(t=e[r])?JSON.parse(t):null}var t;return e}const a=t.length;for(let e=0;e<a;e++){const r=o(t[e]);n.push(r)}const d=[];function s(e,t){if(!(t.childrens&&0!==t.childrens.length||t.indexation&&0!==t.indexation.length)){if(!t.parent)return console.warn("parent not found for row:",t.term_id,t.term,t),!0;const n=t.parent[0],r=e.find(e=>e.term_id===n);if(r){const n=r.childrens.findIndex(e=>e.section_tipo===t.tld&&e.section_id===t.section_id);-1!==n&&(r.childrens.splice(n,1),s(e,r))}d.push(t.term_id)}return!0}for(let e=a-1;e>=0;e--){const t=n[e];!(!t.parent||!t.parent[0])&&t.parent[0]?s(n,t):(console.warn("Ignored undefined parent_term_id:",t.term_id,t.term,t),d.push(t.term_id))}const c=n.filter(e=>-1===d.indexOf(e.term_id));for(let e=0;e<c.length;e++){const t=c[e];r&&-1!==r.indexOf(t.term_id)&&(t.hilite=!0),!0===t.hilite&&l(c,t,!1)}function l(e,t,n){const r=t.parent[0],i=e.find(e=>e.term_id===r);i&&(i.status="opened",l(e,i,!0))}return c},render_form:function(){const e=this,t=document.createElement("form");t.type="form";const n=document.createElement("input");n.id="term",n.name="term",t.appendChild(n);const r=document.createElement("input");return r.type="submit",r.value="Search",r.classList.add("form-group","field"),r.addEventListener("click",(function(t){t.preventDefault(),e.form_submit()})),t.appendChild(r),t},form_submit:function(){const e=this,t=e.form.querySelector("#term");return e.search_rows({q:t.value,q_column:"term"}).then(t=>{const n=t.result.map(e=>e.value);e.term_id=null;const r=e.rows_list_node;for(;r.hasChildNodes();)r.removeChild(r.lastChild);e.load_tree_data({}).then((function(t){const r=t.map((function(e){return-1!==n.indexOf(e.term_id)&&(e.hilite=!0,e.status="closed"),e}));e.render_tree_data({rows:r,set_hilite:!0}).then((function(){}))}))})},search_rows:function(e){const t=this;return new Promise((function(n){const r=e.q,i=e.q_column,o=t.tree_raw_data;n({result:o.filter((function(e){let t=!1;if(r&&r.length>0){const n=e[i].normalize("NFD").replace(/[\u0300-\u036f]/g,"");t=RegExp(r,"i").test(n)}return t})).map(e=>{const t=e.parent[0],n=o.find(e=>e.term_id===t),r=n?" ("+n.term+")":"";return{label:e.term+r,value:e.term_id}})})}))},render_indexation_nodes:function(e){console.log("-- render_indexation_nodes options:",e);const t=e.row,n=e.indexation_container,r=e.instance.caller;return new Promise((function(e){!t.indexation||t.indexation.length<1?e(!1):r.get_indexation_data(t.indexation).then((function(i){const o=i.data_indexation,a=i.data_interview,d=o.reduce((function(e,t){const n=t.index_locator.section_top_id;return e[n]=e[n]||[],e[n].push(t),e}),Object.create(null));for(const e in d){const i=d[e];r.build_indexation_item({data_video_items:i,data_interview:a,term:t.term,parent:n})}e(!0)}))}))},get_indexation_data:function(e){return new Promise((function(t){const n=environment.WEB_CURRENT_LANG_CODE,r=[],i=e.length;for(let t=0;t<i;t++){const i=e[t];r.push({id:"indexation",options:{dedalo_get:"fragment_from_index_locator",index_locator:i,lang:n}})}const o=parseInt(e[0].section_top_id);r.push({id:"interview",options:{dedalo_get:"records",table:"interview",ar_fields:["section_id","code","abstract","date","audiovisual","informant","images","project"],lang:n,sql_filter:"section_id="+o,limit:1,count:!1,resolve_portals_custom:{informant:"informant"}}}),data_manager.request({body:{dedalo_get:"combi",ar_calls:r}}).then((function(e){const n={data_interview:e.result.find(e=>"interview"===e.id).result[0],data_indexation:[]};for(let t=0;t<e.result.length;t++)if("indexation"===e.result[t].id){const r=e.result[t].result;if(!r.video_url){console.warn("Ignored invalid item without video_url:",r);continue}r.type="fragment",r.section_id=r.index_locator.section_id,r.transcription=r.fragm,delete r.fragm,n.data_indexation.push(r)}t(n)}))}))},build_indexation_item:function(e){return new Promise((function(t){const n=e.parent,r=e.data_video_items,i=e.data_interview,o=e.term,a=(r[0].section_id,document.createElement("div"));a.classList.add("indexation_item"),n.appendChild(a);const d=environment.media_base_url+r[0].video_url,s=page.get_posterframe_from_video(d),c=document.createElement("img");c.classList.add("image_indexation_item"),c.src=s,c.addEventListener("click",(function(e){event_manager.publish("open_player",{mode:"indexation",data_interview:i,data_video_items:r,term:o,selected_key:0})})),a.appendChild(c)}))},open_player:function(e){const t=e.data_video_items,n=(e.data_interview,e.term,e.selected_key),r=document.createElement("div");r.classList.add("player_node"),document.body.appendChild(r);const i=document.createElement("div");i.classList.add("close_player"),i.innerHTML="X",i.addEventListener("click",(function(e){d.remove(),r.remove()})),r.appendChild(i);const o=environment.media_base_url+t[n].video_url,a=page.get_posterframe_from_video(o),d=document.createElement("video");return d.src=o,d.poster=a,d.controls=!0,r.appendChild(d),r}};