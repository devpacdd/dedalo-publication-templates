var thematic={row:null,tree:null,form:null,init:function(e){console.log("thematic init options:",e);const t=this;return t.row=e.row,new Promise((function(n){t.table=environment.thesaurus_tables,t.root_term=environment.thesaurus_root_terms,t.term_id=e.term_id||null,common.load_script("./common/factory/tree_factory.js?"+environment.version),common.load_script("./common/factory/form_factory.js?"+environment.version).then((function(e){n(!0)}))}))},render:function(){const e=this,t=e.row,n=new DocumentFragment,r=page.render_lang_selector();n.appendChild(r);const o=page.render_menu();n.appendChild(o);const i=common.create_dom_element({element_type:"div",class_name:"wrapper",parent:n});common.create_dom_element({element_type:"h1",class_name:"title",inner_html:t.title,parent:i});if(t.abstract){common.create_dom_element({element_type:"div",class_name:"abstract",inner_html:t.abstract,parent:i})}const l=e.render_form();return n.appendChild(l),e.rows_list_node=common.create_dom_element({element_type:"div",class_name:"rows_list_node",parent:n}),e.load_tree_data({}).then((function(t){!0===SHOW_DEBUG&&console.log("-> set_up load_tree_data data_clean:",t),e.render_tree_data({rows:t,set_hilite:e.term_id&&e.term_id.length>0}).then((function(){}))})),n},render_tree_data:function(e){const t=this,n=e.rows,r=e.set_hilite||!1;return new Promise((function(e){t.tree=t.tree||new tree_factory,t.tree.init({target:t.rows_list_node,data:n,root_term:t.root_term,set_hilite:r,caller:t}),t.tree.render().then((function(){e(!0)}))}))},load_tree_data:function(e){const t=this;return new Promise((function(n){t.data_clean&&t.data_clean.length>0&&n(t.data_clean);const r=e.sql_filter||!1,o=e.filter||null,i=t.table,l=[],a=function(e){if(e){const t=Object.keys(e)[0],n=e[t],r=[],o=n.length;for(let e=0;e<o;e++){const t=n[e],o=Object.keys(t)[0];if("AND"===o||"OR"===o){const e="("+a(t)+")";r.push(e);continue}const i=-1!==t.field.indexOf("AS")?t.field+" "+t.op+" "+t.value:"`"+t.field+"` "+t.op+" "+t.value;r.push(i),t.group&&l.push(t.group)}return r.join(" "+t+" ")}return null},s=r||a(o);SHOW_DEBUG;const c={dedalo_get:"records",table:i,ar_fields:["*"],sql_filter:s,limit:0,count:!1,order:"norder ASC"};data_manager.request({body:c}).then((function(e){console.log("response:",e);const r=e.result?t.parse_tree_data(e.result):null;t.data_clean=r,n(r)}))}))},parse_tree_data:function(e){const t=[],n=this.term_id?[this.term_id]:null,r=["parent","childrens","space","indexation"];function o(e){for(let n=r.length-1;n>=0;n--){const o=r[n];e[o]=(t=e[o])?JSON.parse(t):null}var t;return e}const i=e.length;for(let n=0;n<i;n++){const r=o(e[n]);t.push(r)}const l=[];function a(e,t){if(!(t.childrens&&0!==t.childrens.length||t.indexation&&0!==t.indexation.length)){if(!t.parent)return console.warn("parent not found for row:",t.term_id,t.term,t),!0;const n=t.parent[0],r=e.find(e=>e.term_id===n);if(r){const n=r.childrens.findIndex(e=>e.section_tipo===t.tld&&e.section_id===t.section_id);-1!==n&&(r.childrens.splice(n,1),a(e,r))}l.push(t.term_id)}return!0}for(let e=i-1;e>=0;e--){const n=t[e];!(!n.parent||!n.parent[0])&&n.parent[0]?a(t,n):(console.warn("Ignored undefined parent_term_id:",n.term_id,n.term,n),l.push(n.term_id))}const s=t.filter(e=>-1===l.indexOf(e.term_id));for(let e=0;e<s.length;e++){const t=s[e];n&&-1!==n.indexOf(t.term_id)&&(t.hilite=!0),!0===t.hilite&&c(s,t,!1)}function c(e,t,n){const r=t.parent[0],o=e.find(e=>e.term_id===r);o&&(o.status="opened",c(e,o,!0))}return s},render_form:function(){const e=this,t=new DocumentFragment;e.form=e.form||new form_factory;const n=common.create_dom_element({element_type:"div",class_name:"global_search_container form-row fields",parent:t});e.form.item_factory({id:"term",name:"term",label:tstring.term||"Term",q_column:"term",eq:"LIKE",eq_in:"%",eq_out:"%",parent:n,callback:function(e){}});const r=common.create_dom_element({element_type:"div",class_name:"form-group field",parent:t});return common.create_dom_element({element_type:"input",type:"submit",id:"submit",value:tstring.buscar||"Search",class_name:"btn btn-light btn-block primary",parent:r}).addEventListener("click",(function(t){t.preventDefault(),e.form_submit()})),e.form.node=common.create_dom_element({element_type:"form",id:"search_form",class_name:"form-inline"}),e.form.node.appendChild(t),e.form.node},form_submit:function(){const e=this,t=e.form.form_items,n=t.term;console.log("form_items:",t),console.log("form_item:",n);return e.search_rows({q:n.q,q_column:n.q_column,q_selected:n.q_selected,limit:0}).then(t=>{!0===SHOW_DEBUG&&console.log("--- form_submit response:",t);const n=t.result.map(e=>e.value);e.term_id=null;const r=e.rows_list_node;for(;r.hasChildNodes();)r.removeChild(r.lastChild);const o=common.create_dom_element({element_type:"div",id:"spinner",class_name:"spinner",parent:r});e.load_tree_data({}).then((function(t){console.log("/// load_tree_data response:",t);const r=t.map((function(e){return-1!==n.indexOf(e.term_id)&&(e.hilite=!0,e.status="closed"),e}));e.render_tree_data({rows:r,set_hilite:!0}).then((function(){o.remove()}))}))})},search_rows:function(e){!0===SHOW_DEBUG&&console.log("----\x3e search_rows options:",e);const t=this;return new Promise((function(n){const r=performance.now(),o=e.q,i=e.q_column,l=e.q_selected||null,a=e.limit,s=t.data_clean.map(e=>({term:e.term,scope_note:e.scope_note,parent:e.parent,term_id:e.term_id}));var c=1;n({result:s.filter((function(e){if(a>0&&c>a)return!1;let t=!1;if(o&&o.length>0){const n=e[i].normalize("NFD").replace(/[\u0300-\u036f]/g,"");t=RegExp(o,"i").test(n)}if(!t&&l)for(let n=0;n<l.length;n++)if(e.term_id===l[n]){t=!0;break}return!0===t&&c++,t})).map(e=>{const n=e.parent[0],r=t.data_clean.find(e=>e.term_id===n),o=r?" ("+r.term+")":"";return{label:e.term+o,value:e.term_id}}),debug:{time:performance.now()-r}})}))}};