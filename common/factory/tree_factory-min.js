"use strict";function tree_factory(){this.target=null,this.data=null,this.root_term=null,this.caller,this.init=function(e){const t=this;t.target=e.target,t.data=e.data,t.caller=e.caller,t.set_hilite=e.set_hilite||!1,t.hilite_relations_limit=15,t.hilite_relations_showed=0,t.hilite_indexation_limit=15,t.hilite_indexation_showed=0;const n=sessionStorage.getItem("tree_state");if(n&&!t.set_hilite){t.tree_state=JSON.parse(n);const e=t.data.length;for(let n=0;n<e;n++){const e=t.tree_state.find(e=>e.id===t.data[n].term_id);e&&(t.data[n].state=e.state)}}else{t.tree_state=[];const e=t.data.length;for(let n=0;n<e;n++){const e=t.data[n].status||"closed";t.data[n].state=e,t.tree_state.push({id:t.data[n].term_id,state:e})}sessionStorage.setItem("tree_state",JSON.stringify(t.tree_state))}return t.root_term=e.root_term,t.status="initied",!0},this.render=function(e){const t=this,n=t.target,i=t.data,o=t.root_term;return new Promise((function(e){const n=new DocumentFragment,s=common.create_dom_element({element_type:"div",class_name:"tree_wrapper",parent:n}),a=[],r=i.length;for(let e=0;e<r;e++){const n=i[e];"yes"===n.descriptor?a.push(t.build_tree_node(n)):console.warn("Skipped build_tree_node of term ND :",n.term_id,n.term)}const l=a.length;for(let e=0;e<l;e++){const t=a[e],n=t.term_id;if(-1!==o.indexOf(n))s.appendChild(t);else{const e=t.parent?t.parent[0]:null;if(!e){console.log("skip non parent defined tree_node:",t);continue}const n=a.find(t=>t.term_id===e);n&&n.branch&&n.branch.appendChild(t)}}e(n)})).then((function(e){return n.appendChild(e),!0===t.set_hilite&&common.when_in_dom(n,(function(){const e=n.querySelector(".term.hilite");e&&e.scrollIntoView({behavior:"auto",block:"center",inline:"nearest"})})),e}))},this.build_tree_node=function(e){const t=this,n=common.create_dom_element({element_type:"div",class_name:"tree_node",id:e.term_id});n.term_id=e.term_id,n.parent=e.parent;const i=e.term,o=!0===(e.hilite&&!0===e.hilite)?" hilite":"";common.create_dom_element({element_type:"span",class_name:"term"+o,inner_html:i,parent:n});if(e.nd&&e.nd.length>0&&common.create_dom_element({element_type:"span",class_name:"nd",inner_html:"["+e.nd.join(", ")+"]",parent:n}),e.scope_note&&e.scope_note.length>0){common.create_dom_element({element_type:"span",class_name:"btn_scope_note",parent:n}).addEventListener("mousedown",(function(){this.classList.contains("open")?(r.classList.add("hide"),this.classList.remove("open")):(r.classList.remove("hide"),this.classList.add("open"))}))}let s,a,r,l,d,_;if(e.relations&&e.relations.length>0&&(s=common.create_dom_element({element_type:"span",class_name:"btn_relations",parent:n}),s.addEventListener("mousedown",(function(){this.classList.contains("open")?(l.classList.add("hide"),this.classList.remove("open")):(l.classList.remove("hide"),this.classList.add("open"))}))),e.indexation&&e.indexation.length>0&&(a=common.create_dom_element({element_type:"span",class_name:"btn_indexation",parent:n}),a.addEventListener("mousedown",(function(){this.classList.contains("open")?(d.classList.add("hide"),this.classList.remove("open")):(d.classList.remove("hide"),this.classList.add("open"))}))),e.scope_note&&e.scope_note.length>0){e.state;const t=e.scope_note.replace(/^\s*<br\s*\/?>|<br\s*\/?>\s*$/g,"");r=common.create_dom_element({element_type:"div",class_name:"scope_note hide",inner_html:t,parent:n})}if(e.relations&&e.relations.length>0){l=common.create_dom_element({element_type:"div",class_name:"relations_container hide",parent:n});const i=function(n,i){for(let o of n)"attributes"===o.type&&"class"===o.attributeName&&(n[0].target.classList.contains("hide")||(t.render_relation_nodes(e,l,t,!1),i.disconnect()))};new MutationObserver(i).observe(l,{attributes:!0,childList:!1,subtree:!1}),!0===e.hilite&&t.hilite_relations_showed<t.hilite_relations_limit&&(l.classList.remove("hide"),s.classList.add("open"),t.hilite_relations_showed++)}if(e.indexation&&e.indexation.length>0){d=common.create_dom_element({element_type:"div",class_name:"indexation_container hide",parent:n});const i=function(n,i){for(let o of n)"attributes"===o.type&&"class"===o.attributeName&&(n[0].target.classList.contains("hide")||(t.render_indexation_nodes(e,d,t),i.disconnect()))};new MutationObserver(i).observe(d,{attributes:!0,childList:!1,subtree:!1}),!0===e.hilite&&t.hilite_indexation_showed<t.hilite_indexation_limit&&(d.classList.remove("hide"),a.classList.add("open"),t.hilite_indexation_showed++)}if(e.childrens&&e.childrens.length>0){const i="opened"===e.state?" open":"";common.create_dom_element({element_type:"span",class_name:"arrow"+i,parent:n}).addEventListener("mousedown",(function(){let n;this.classList.contains("open")?(_.classList.add("hide"),this.classList.remove("open"),n="closed"):(_.classList.remove("hide"),this.classList.add("open"),n="opened");const i=t.tree_state.find(t=>t.id===e.term_id);i&&i.state!==n&&(i.state=n,sessionStorage.setItem("tree_state",JSON.stringify(t.tree_state)))}))}if(e.childrens&&e.childrens.length>0){const t="opened"===e.state?"":" hide";_=common.create_dom_element({element_type:"div",class_name:"branch"+t,parent:n}),n.branch=_}else n.branch=null;return n},this.render_relation_nodes=function(e,t,n,i){return new Promise((function(i){(!e.relations||e.relations.length<1)&&i(!1);const o=[];for(let i=0;i<e.relations.length;i++){const s=n.build_relation_item({data:e.relations[i],parent:t,row:e});o.push(s)}Promise.all(o).then(e=>{for(let t=0;t<e.length;t++);}),i(!0)}))},this.build_relation_item=function(e){e.parent;const t=e.data;return new Promise((function(n){t.image_url;const i=t.thumb_url,o=t.title,s=o||"",a=common.create_dom_element({element_type:"div",class_name:"relation_item",title:s+(SHOW_DEBUG?" ["+e.data.table+" "+e.data.section_tipo+" "+e.data.section_id+"]":"")});page.build_image_with_background_color(i,a).then((function(e){const n=e.img;a.appendChild(n),n.addEventListener("mousedown",(function(){const e="pictures"===t.table?"picture":"object",n=page_globals.__WEB_ROOT_WEB__+"/"+e+"/"+t.section_id;window.open(n).focus()}))})),n(a)}))},this.render_indexation_nodes=function(e,t,n){return!0===SHOW_DEBUG&&console.log("-- render_indexation_nodes row:",e),new Promise((function(i){(!e.indexation||e.indexation.length<1)&&i(!1),"function"!=typeof n.caller.get_indexation_data&&(console.warn("Ignored render_indexation_nodes call to undefined caller function 'get_indexation_data'"),i(!1)),n.caller.get_indexation_data(e.indexation).then((function(o){const s=o.data_indexation,a=o.data_interview,r=s.reduce((function(e,t){const n=t.index_locator.section_top_id;return e[n]=e[n]||[],e[n].push(t),e}),Object.create(null));for(const i in r){const o=r[i];n.build_indexation_item({data_video_items:o,data_interview:a,term:e.term,parent:t})}i(!0)}))}))},this.build_indexation_item=function(e){console.warn("-- build_indexation_item options:",e);return new Promise((function(t){const n=e.parent,i=e.data_video_items,o=e.data_interview,s=e.term,a=i[0].section_id,r=common.create_dom_element({element_type:"div",class_name:"indexation_item",parent:n}),l=a?common.get_media_engine_url(a,"posterframe","thumb",!0):__WEB_TEMPLATE_WEB__+"/assets/images/default_thumb.jpg";page.build_image_with_background_color(l,r,null).then((function(e){const n=e.img;r.appendChild(n);n.addEventListener("click",(function(){event_manager.publish("open_video",{mode:"indexation",data_interview:o,data_video_items:i,term:s,selected_key:0})})),t(n)}))}))},this.get_thesaurus_children=function(e){return new Promise((function(t){const n=e.join(",");data_manager.request({body:{dedalo_get:"thesaurus_childrens",db_name:page_globals.WEB_DB,lang:page_globals.WEB_CURRENT_LANG_CODE,ar_fields:["term_id"],term_id:n,recursive:!0,only_descriptors:!0,remove_restricted:!1,multiple:!0}}).then((function(e){const n=[],i=e.result;for(let e=0;e<i.length;e++){const t=i[e].result;for(let e=0;e<t.length;e++)n.push(t[e])}t(n.map((function(e){return e.term_id})))}))}))}}function getRandomInt(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e)+e)}