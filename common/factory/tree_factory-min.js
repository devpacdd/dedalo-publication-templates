"use strict";function tree_factory(){this.target=null,this.data=null,this.root_term=null,this.caller,this.init=function(e){const t=this;t.target=e.target,t.data=e.data,t.caller=e.caller,t.set_hilite=e.set_hilite||!1,t.hilite_relations_limit=15,t.hilite_relations_showed=0,t.hilite_indexation_limit=15,t.hilite_indexation_showed=0;const n=sessionStorage.getItem("tree_state");if(n&&!t.set_hilite){t.tree_state=JSON.parse(n);const e=t.data.length;for(let n=0;n<e;n++){const e=t.tree_state.find(e=>e.id===t.data[n].term_id);e&&(t.data[n].state=e.state)}}else{t.tree_state=[];const e=t.data.length;for(let n=0;n<e;n++){const e=t.data[n].status||"closed";t.data[n].state=e,t.tree_state.push({id:t.data[n].term_id,state:e})}sessionStorage.setItem("tree_state",JSON.stringify(t.tree_state))}return t.root_term=e.root_term,t.status="initied",!0},this.render=function(e){const t=this,n=t.target,i=t.data,s=t.root_term;return new Promise((function(e){const n=new DocumentFragment,a=t.create_dom_element({element_type:"div",class_name:"tree_wrapper",parent:n}),o=[],r=i.length;for(let e=0;e<r;e++){const n=i[e];"yes"===n.descriptor?o.push(t.build_tree_node(n)):console.warn("Skipped build_tree_node of term ND :",n.term_id,n.term)}const l=o.length;for(let e=0;e<l;e++){const t=o[e],n=t.term_id;if(-1!==s.indexOf(n))a.appendChild(t);else{const e=t.parent?t.parent[0]:null;if(!e){console.log("skip non parent defined tree_node:",t);continue}const n=o.find(t=>t.term_id===e);n&&n.branch&&n.branch.appendChild(t)}}e(n)})).then((function(e){return n.appendChild(e),!0===t.set_hilite&&event_manager.when_in_dom(n,(function(){const e=n.querySelector(".term.hilite");e&&e.scrollIntoView({behavior:"auto",block:"center",inline:"nearest"})})),e}))},this.build_tree_node=function(e){const t=this,n=t.create_dom_element({element_type:"div",class_name:"tree_node",id:e.term_id});n.term_id=e.term_id,n.parent=e.parent;const i=e.term,s=!0===(e.hilite&&!0===e.hilite)?" hilite":"";t.create_dom_element({element_type:"span",class_name:"term"+s,inner_html:i,parent:n});if(e.nd&&e.nd.length>0&&t.create_dom_element({element_type:"span",class_name:"nd",inner_html:"["+e.nd.join(", ")+"]",parent:n}),e.scope_note&&e.scope_note.length>0){t.create_dom_element({element_type:"span",class_name:"btn_scope_note",parent:n}).addEventListener("mousedown",(function(){this.classList.contains("open")?(r.classList.add("hide"),this.classList.remove("open")):(r.classList.remove("hide"),this.classList.add("open"))}))}let a,o,r,l,d,_;if(e.relations&&e.relations.length>0&&(a=t.create_dom_element({element_type:"span",class_name:"btn_relations",parent:n}),a.addEventListener("mousedown",(function(){this.classList.contains("open")?(l.classList.add("hide"),this.classList.remove("open")):(l.classList.remove("hide"),this.classList.add("open"))}))),e.indexation&&e.indexation.length>0&&(o=t.create_dom_element({element_type:"span",class_name:"btn_indexation",parent:n}),o.addEventListener("mousedown",(function(){this.classList.contains("open")?(d.classList.add("hide"),this.classList.remove("open")):(d.classList.remove("hide"),this.classList.add("open"))}))),e.scope_note&&e.scope_note.length>0){e.state;const i=e.scope_note.replace(/^\s*<br\s*\/?>|<br\s*\/?>\s*$/g,"");r=t.create_dom_element({element_type:"div",class_name:"scope_note hide",inner_html:i,parent:n})}if(e.relations&&e.relations.length>0){l=t.create_dom_element({element_type:"div",class_name:"relations_container hide",parent:n});const i=function(n,i){for(let s of n)"attributes"===s.type&&"class"===s.attributeName&&(n[0].target.classList.contains("hide")||(t.render_relation_nodes(e,l,t,!1),i.disconnect()))};new MutationObserver(i).observe(l,{attributes:!0,childList:!1,subtree:!1}),!0===e.hilite&&t.hilite_relations_showed<t.hilite_relations_limit&&(l.classList.remove("hide"),a.classList.add("open"),t.hilite_relations_showed++)}if(e.indexation&&e.indexation.length>0){d=t.create_dom_element({element_type:"div",class_name:"indexation_container hide",parent:n});const i=function(n,i){for(let s of n)"attributes"===s.type&&"class"===s.attributeName&&(n[0].target.classList.contains("hide")||(event_manager.publish("show_indexation_nodes",{row:e,indexation_container:d,instance:t}),i.disconnect()))};new MutationObserver(i).observe(d,{attributes:!0,childList:!1,subtree:!1}),!0===e.hilite&&t.hilite_indexation_showed<t.hilite_indexation_limit&&(d.classList.remove("hide"),o.classList.add("open"),t.hilite_indexation_showed++)}if(e.children&&e.children.length>0){const i="opened"===e.state?" open":"";t.create_dom_element({element_type:"span",class_name:"arrow"+i,parent:n}).addEventListener("mousedown",(function(){let n;this.classList.contains("open")?(_.classList.add("hide"),this.classList.remove("open"),n="closed"):(_.classList.remove("hide"),this.classList.add("open"),n="opened");const i=t.tree_state.find(t=>t.id===e.term_id);i&&i.state!==n&&(i.state=n,sessionStorage.setItem("tree_state",JSON.stringify(t.tree_state)))}))}if(e.children&&e.children.length>0){const i="opened"===e.state?"":" hide";_=t.create_dom_element({element_type:"div",class_name:"branch"+i,parent:n}),n.branch=_}else n.branch=null;return n},this.render_relation_nodes=function(e,t,n,i){return new Promise((function(i){(!e.relations||e.relations.length<1)&&i(!1);const s=[];for(let i=0;i<e.relations.length;i++){const a=n.build_relation_item({data:e.relations[i],parent:t,row:e});s.push(a)}Promise.all(s).then(e=>{for(let t=0;t<e.length;t++);}),i(!0)}))},this.build_relation_item=function(e){const t=this,n=(e.parent,e.data);return new Promise((function(i){n.image_url;const s=n.thumb_url,a=n.title,o=a||"",r=t.create_dom_element({element_type:"div",class_name:"relation_item",title:o+(SHOW_DEBUG?" ["+e.data.table+" "+e.data.section_tipo+" "+e.data.section_id+"]":"")});page.build_image_with_background_color(s,r).then((function(e){const t=e.img;r.appendChild(t),t.addEventListener("mousedown",(function(){const e="pictures"===n.table?"picture":"object",t=page_globals.__WEB_ROOT_WEB__+"/"+e+"/"+n.section_id;window.open(t).focus()}))})),i(r)}))},this.build_indexation_item=function(e){console.warn("-- build_indexation_item options:",e);const t=this;return new Promise((function(n){const i=e.parent,s=e.data_video_items,a=e.data_interview,o=e.term,r=s[0].section_id,l=t.create_dom_element({element_type:"div",class_name:"indexation_item",parent:i}),d=r?common.get_media_engine_url(r,"posterframe","thumb",!0):__WEB_TEMPLATE_WEB__+"/assets/images/default_thumb.jpg";page.build_image_with_background_color(d,l,null).then((function(e){const t=e.img;l.appendChild(t);t.addEventListener("click",(function(){event_manager.publish("open_video",{mode:"indexation",data_interview:a,data_video_items:s,term:o,selected_key:0})})),n(t)}))}))},this.get_thesaurus_children=function(e){return new Promise((function(t){const n=e.join(",");data_manager.request({body:{dedalo_get:"thesaurus_children",db_name:page_globals.WEB_DB,lang:page_globals.WEB_CURRENT_LANG_CODE,ar_fields:["term_id"],term_id:n,recursive:!0,only_descriptors:!0,remove_restricted:!1,multiple:!0}}).then((function(e){const n=[],i=e.result;for(let e=0;e<i.length;e++){const t=i[e].result;for(let e=0;e<t.length;e++)n.push(t[e])}t(n.map((function(e){return e.term_id})))}))}))},this.create_dom_element=function(e){const t=e.element_type,n=e.parent,i=e.class_name,s=e.style,a=e.data_set||e.dataset,o=e.custom_function_events,r=e.title_label||e.title,l=e.text_node,d=e.text_content,_=e.inner_html,c=e.href,m=e.id,h=e.draggable,p=e.value,u=e.download,f=e.src,g=e.placeholder,b=e.type,v=e.target,L=document.createElement(t);if(m&&(L.id=m),"a"===t&&(L.href=c||"javascript:;",v&&(L.target=v)),i&&(L.className=i),s)for(w in s)L.style[w]=s[w];if(r&&(L.title=r),a)for(var w in a)L.dataset[w]=a[w];if(p&&(L.value=p),b&&L.setAttribute("type",b),o){const e=o.length;for(let t=0;t<e;t++){const e=o[t].name,n=o[t].type,i=o[t].function_arguments;this.create_custom_events(L,n,e,i)}}if(l)if("span"===t)L.textContent=l;else{const e=document.createElement("span");e.insertAdjacentHTML("afterbegin"," "+l),L.appendChild(e)}else d?L.textContent=d:_&&L.insertAdjacentHTML("afterbegin",_);return n&&n.appendChild(L),h&&(L.draggable=h),u&&L.setAttribute("download",u),f&&(L.src=f),g&&(L.placeholder=g),L}}